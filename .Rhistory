# Create working directory
create_and_set_directory <- function(
dir_e = NULL,
root_dir = wd
) {
# Validar que root_dir no sea NULL
if (is.null(root_dir) || root_dir == "") {
stop("Root working directory empty")
}
# Construir path completo
target_dir <- if (!is.null(dir_e)) {
normalizePath(file.path(root_dir, dir_e), mustWork = FALSE)
} else {
normalizePath(root_dir, mustWork = FALSE)
}
# Crear directorio si no existe
if (!dir.exists(target_dir)) {
success <- tryCatch({
dir.create(target_dir, recursive = TRUE)
TRUE
}, error = function(e) FALSE)
if (!success) {
stop(paste("Error creating directory:", target_dir))
}
message(paste("✓ Directory created:", target_dir))
} else {
message(paste("✓ Directory exists:", target_dir))
}
# Establecer directorio de trabajo
old_wd <- getwd()
setwd(target_dir)
message(paste("✓ Working directory changed from:", old_wd))
message(paste("✓ Working directory set to:", getwd()))
return(invisible(getwd()))
}
setup_packages <- function(packages, repos = "https://cloud.r-project.org") {
installed <- rownames(installed.packages())
to_install <- packages[!packages %in% installed]
if (length(to_install) > 0) {
message("Installing packages: ", paste(to_install, collapse = ", "))
install.packages(to_install, repos = repos)
}
invisible(lapply(packages, function(pkg) {
if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
stop("Cannot load: ", pkg)
}
}))
}
packages <- c('data.table', 'stringr', 'tidyverse', 'KnowBR', 'sf', 'terra',
'rnaturalearth', 'ggplot2', 'svglite', 'patchwork', 'here',
'ggExtra', 'biscale', 'cowplot', 'tidyterra', 'maps',
'nFactors', 'rSDM', 'psych', 'ggside', 'gridExtra',
'sampbias', 'viridis', 'tidyr', 'stringr', 'exactextractr')
to_install <- packages[!packages %in% installed]
installed <- rownames(installed.packages())
to_install <- packages[!packages %in% installed]
setup_packages <- function(packages, repos = "https://cloud.r-project.org") {
installed <- rownames(installed.packages())
to_install <- packages[!packages %in% installed]
# Install if needed
if (length(to_install) > 0) {
message("Installing ", length(to_install), " package(s): ",
paste(to_install, collapse = ", "))
# Try installation with error handling
tryCatch({
install.packages(to_install, repos = repos, dependencies = TRUE)
}, error = function(e) {
stop("Failed to install package(s): ", paste(to_install, collapse = ", "),
"\nError: ", e$message)
})
# Verify installation was successful
newly_installed <- rownames(installed.packages())
still_missing <- to_install[!to_install %in% newly_installed]
if (length(still_missing) > 0) {
stop("Failed to install: ", paste(still_missing, collapse = ", "))
}
}
# Load/attach all packages
for (pkg in packages) {
# Use requireNamespace for checking without attaching
if (!requireNamespace(pkg, quietly = TRUE)) {
stop("Package '", pkg, "' is not available")
}
# Use library to attach to search path
if (!suppressPackageStartupMessages(
require(pkg, character.only = TRUE, quietly = TRUE))) {
stop("Cannot load package: ", pkg)
}
}
message("Successfully loaded ", length(packages), " package(s)")
return(invisible(TRUE))
}
# Required packages
required_pkgs <- c('data.table', 'stringr', 'tidyverse', 'KnowBR', 'sf', 'terra',
'rnaturalearth', 'ggplot2', 'svglite', 'patchwork', 'here',
'ggExtra', 'biscale', 'cowplot', 'tidyterra', 'maps',
'nFactors', 'rSDM', 'psych', 'ggside', 'gridExtra',
'sampbias', 'viridis', 'tidyr', 'stringr', 'exactextractr')
# Setup packages
setup_packages(required_pkgs)
test_url <- "https://cloud.r-project.org"
cat("Testing connection to:", test_url, "\n")
setup_packages_simple <- function(packages, repos = "https://cloud.r-project.org") {
packages <- unique(packages)
# Check installation
installed <- rownames(installed.packages())
to_install <- packages[!packages %in% installed]
if (length(to_install) > 0) {
cat("Installing:", paste(to_install, collapse = ", "), "\n")
# Try installation
tryCatch({
install.packages(to_install, repos = repos, dependencies = TRUE)
}, error = function(e) {
cat("Installation error:", e$message, "\n")
cat("Trying without dependencies...\n")
install.packages(to_install, repos = repos, dependencies = FALSE)
})
}
# Load packages
for (pkg in packages) {
cat("Loading:", pkg, "... ")
success <- tryCatch({
library(pkg, character.only = TRUE, quietly = TRUE)
cat("OK\n")
TRUE
}, error = function(e) {
cat("FAILED -", e$message, "\n")
FALSE
})
if (!success) {
# Try require
if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
warning("Package '", pkg, "' could not be loaded")
} else {
cat("Loaded with require()\n")
}
}
}
cat("\nSetup complete!\n")
}
Sys.setenv(http_proxy = "http://proxy:port")
# Setup packages
setup_packages(required_pkgs, repos = 'https://cran.r-project.org')
# Obtener datos del mundo y filtrar para España
spain <- ne_countries(country = "Spain", scale = "medium", returnclass = "sf")
# También obtener países vecinos para contexto
europe <- ne_countries(continent = "Europe", scale = "medium", returnclass = "sf")
# Coordenadas del punto (42.16° N, 1.1° O)
# Nota: En R, las longitudes Oeste son negativas
punto <- data.frame(
nombre = "Punto Específico",
longitud = -1.1,  # 1.1° O es -1.1 en coordenadas decimales
latitud = 42.16
)
# Coordenadas del punto (42.16° N, 1.1° O)
# Nota: En R, las longitudes Oeste son negativas
punto <- data.frame(
nombre = "Artieda (Zaragoza)",
longitud = -1.1,  # 1.1° O es -1.1 en coordenadas decimales
latitud = 42.16
)
# Convertir a objeto sf
punto_sf <- st_as_sf(punto, coords = c("longitud", "latitud"), crs = 4326)
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "lightblue", color = "darkblue", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "red", size = 4, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 2, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Coordenadas del punto como texto
annotate("text",
x = -1.1, y = 41.8,
label = "42.16° N, 1.1° O",
size = 3, color = "darkred", fontface = "italic") +
# Título y subtítulo
labs(title = "Mapa de España con punto específico",
subtitle = "Ubicación: 42.16° N de latitud, 1.1° O de longitud",
caption = "Fuente: rnaturalearth | Coordenadas aproximadas") +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
# Tema minimalista
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, color = "gray50", size = 9),
panel.grid.major = element_line(color = "gray80", size = 0.2),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "lightblue", color = "darkblue", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "red", size = 4, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 2, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Coordenadas del punto como texto
annotate("text",
x = -1.1, y = 41.8,
label = "42.16° N, 1.1° O",
size = 3, color = "darkred", fontface = "italic") +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, color = "gray50", size = 9),
panel.grid.major = element_line(color = "gray80", size = 0.2),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "lightblue", color = "darkblue", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "red", size = 4, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 2, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Coordenadas del punto como texto
annotate("text",
x = -1.1, y = 41.8,
label = "",
size = 3, color = "darkred", fontface = "italic") +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, color = "gray50", size = 9),
panel.grid.major = element_blank(),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
colourpicker:::plotHelperAddin()
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "moccasin", color = "black", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "red", size = 4, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 2, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Coordenadas del punto como texto
annotate("text",
x = -1.1, y = 41.8,
label = "",
size = 3, color = "darkred", fontface = "italic") +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, color = "gray50", size = 9),
panel.grid.major = element_blank(),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "moccasin", color = "black", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "#25996C", size = 4, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 2, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, color = "gray50", size = 9),
panel.grid.major = element_blank(),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
ggsave('mapaEcoinfArtieda.png', dpi=600, plot=last_plot())
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "moccasin", color = "black", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "#25996C", size = 5, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 3, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 3.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
panel.grid.major = element_blank(),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
# Crear el mapa centrado en España
ggplot() +
# Países de Europa (fondo)
geom_sf(data = europe, fill = "lightgray", color = "gray70", size = 0.2) +
# España (resaltada)
geom_sf(data = spain, fill = "moccasin", color = "black", size = 0.5) +
# Punto específico
geom_sf(data = punto_sf, color = "#25996C", size = 5, shape = 19) +
geom_sf(data = punto_sf, color = "white", size = 3, shape = 19) +
# Etiqueta del punto
geom_sf_label(data = punto_sf,
aes(label = nombre),
nudge_y = 0.5,
size = 5.5,
fill = "white",
alpha = 0.7,
label.padding = unit(0.15, "lines")) +
# Zoom en España
coord_sf(xlim = c(-10, 5), ylim = c(36, 44)) +
xlab('')+
ylab('')+
# Tema minimalista
theme_minimal() +
theme(
panel.grid.major = element_blank(),
panel.background = element_rect(fill = "aliceblue"),
legend.position = "none"
)
ggsave('mapaEcoinfArtieda.png', dpi=600, plot=last_plot())
